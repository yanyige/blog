---
layout: default
title: jQuery源码分析 (第二部分)
---
# 第一章 构造jQuery对象
jQuery对象是一个类数组对象，含有连续的整型属性、length属性和大量的jQuery方法。jQuery对象由构造函数jQuery()创建，$()则是jQuery()的缩写。
## 2.1 构造函数jQuery()
如果调用构造函数jQuery时传入的参数不同，创建jQuery对象的逻辑也会不同，构造函数jQuery有7种方法。如下：
- jQuery( selector [, context])接受一个css表达式和一个可选的选择器上下文，返回了一个包含匹配DOM元素的jQuery对象。
- jQuery (html [,ownerDocument])、jQuery(html, props) 创建一个DOM元素
- jQuery( element)、jQuery( elementArray ) 如果传入一个DOM元素或者DOM数组，则会把DOM元素封装到jQuery对象中并且返回
- jQuery( callback )
- jQuery( jQuery object )
- jQUery( )

### 2.1.1 jQuery( selector [, context])
如果传入一个字符串参数，jQuery会检查这个字符串是选择器还是html代码，如果是选择器表达式，则遍历文档，查找与之匹配的DOM元素，并创建一个包含了这些DOM元素引用的jQuery对象；如果没有匹配的对象，则会创建一个空jQuery对象。下一节介绍参数是HTML代码的情况。  
默认情况下，对匹配元素的查找将会从document对象开始，即查找整个文档树，不过也可以传入第二个参数context来限定查找范围。例如，可以这样限制查找范围。
```
$('div.foo').click(function() {
    $('span', this).addClass('bar');
});
```
方法find是调用CSS选择器引擎Sizzle实现，会在第三章进行介绍和分析。
### 2.1.2 jQuery ( html [,ownerDocument] )、jQuery( html, props )
如果传入的参数是一段html代码，jQuery则会尝试用这段HTML代码创建新的DOM元素，并且创建一个包含了这些DOM元素引入的jQuery对象。  
第二个参数ownerDocument用于指定创建的新的DOM元素的文档对象，如果不传入，则默认为当前文档对象。  
第二个参数还可以是props。属性可以是任意的时间类型（如"click"）还可以有下面的特殊属性:val, css, html, text, data, width, height, offset, 对应的jQuery方法: .val(), .css(), .html(), .text(), data(), width(), height(), offset()将会执行。举个梨子：
```
$('<div>', {
    "class": "test",
    text: "click me",
    click: function() {
        $(this).toggleClass("test");
    }
}).appendTo("body")
```
### 2.1.3 jQuery( element)、jQuery( elementArray )
如果传入一个DOM元素或者DOM数组，则会把DOM元素封装到jQuery对象中并且返回。

### 2.1.4 jQuery( object )
如果传入一个普通的jQuery对象，则会把这个对象封装jQuery对象中并且返回。
举个梨子:
```
var foo = {foo: 'bar', hello: 'world'};

var $foo = $(foo);

$foo.on('custom', function(){
    console.log('custom event is called');
});

$foo.triggle('custom');
```

### 2.1.5 jQuery( callback )
如果传入一个函数，则在document上绑定一个ready事件监听函数，当DOM结构加载完成时执行。ready事件触发要早于load事件。ready事件并不是浏览器的原生事件，而是DOMContentLoaded事件、onreadystatechange事件和函数doScrollCheck()的统称。将在后面的学习中介绍。

### 2.1.6 jQuery( jQuery object )
如果传入一个jQuery对象，则创建这个jQuery对象的一个副本并且返回，副本与传入的jQuery对象引入的同一个元素。

## 2.2 总体结构

构造jQuery对象模块源码架构如下：
```
(function( window, undefined ) {
	 // 构造 jQuery 对象
22　 var jQuery = (function() {
25　 var jQuery = function( selector, context ) {
27　 	return new jQuery.fn.init( selector, context, root jQuery );
28　 },
	 // 一堆局部变量声明
97　 jQuery.fn = jQuery.prototype = {
98　 	constructor: jQuery,
99　 	init: function( selector, context, rootjQuery ) { ... },
	 	// 一堆原型属性和方法
319　};
322　jQuery.fn.init.prototype = jQuery.fn;
324　jQuery.extend = jQuery.fn.extend = function() { ... };
388　jQuery.extend({
// 一堆静态属性和方法
892　 });
955　 return jQuery;
957 })();
// 省略其他模块的代码
9246　 window.jQuery = window.$ = jQuery;
9266　})( window );
```

#### 这里解释一下为什么要在第97行执行 jQuery.fn = jQuery.prototype, 设置jQuery.fn指向构造函数jQuery()的原型对象。  
jQuery.fn 是jQuery.prototype 的简写，可以少写7 个字符，以方便拼写。

## 2.3 jQuery.fn.init( selector, context, rootjQuery )

### 2.3.1 12个分支

### 2.3.2 源码分析

#### 1.定义jQuery.fn.init( selector, context, rootjQuery )
相关代码如下所示：  
```
99  init: function( selector, context, rootjQuery ) {
100 	var match, elem, ret, doc;

// document.getElementById() 查找失败
172 	return rootjQuery.find( selector );

// selector 是选择器表达式且未指定 context
187 	return ( context || rootjQuery ).find( selector );

// selector 是函数
198 return rootjQuery.ready( selector );

// 定义 rootjQuery
916 // All jQuery objects should point back to these
917 rootjQuery = jQuery(document);
```

#### 2. 参数selector 可以转换为false
参数selector 可以转换为false，例如是undefined、空字符串、null 等，则直接返回this，此时this 是空jQuery 对象，其属性length 等于0。

#### 3. 参数selector 是DOM元素
如果参数selector 有属性nodeType，则认为selector 是DOM 元素，手动设置第一个元素和属性context指向该DOM元素、属性length为1，然后返回包含了该DOM 元素引用的jQuery对象。

相关代码：
```
107 // Handle $(DOMElement)
108 if ( selector.nodeType ) {
109 	this.context = this[0] = selector;
110 	this.length = 1;
111 	return this;
112 }
113
```

#### 4. 参数selector是字符串“body”

如果参数selector 是字符串“ body”，手动设置属性context 指向document 对象、第一个元素指向body元素、属性length 为1，最后返回包含了body元素引用的jQuery 对象。这里是对查找字符串“ body”的优化，因为文档树中只会存在一个body 元素。相关代码如下所示：
```
114 // The body element only exists once, optimize finding it
115 if ( selector === "body" && !context && document.body ) {
116 	this.context = document;
117 	this[0] = document.body;
118 	this.selector = selector;
119 	this.length = 1;
120 	return this;
121 }
122
```

#### 5. 参数selector还可以是复杂字符串
此时会根据context参数来返回不同的结果。
```
return( context|| rootjQuery ).find( selector );
```

## 2.4 jQuery.buildFragment( args, nodes, scripts )

### 2.4.1 实现原理
方法jQuery.buildFragment( args, nodes, scripts ) 先创建一个文档片段DocumentFragment，然后调用方法jQuery.clean( elems, context, fragment, scripts ) 将HTML 代码转换为DOM 元素，并存储在创建的文档片段中。文档片段DocumentFragment 表示文档的一部分，但不属于文档树。当把DocumentFragment 插入文档树时，插入的不是DocumentFragment 自身，而是它的所有子孙节点，即可以一次向文档树中插入多个节点。当需要插入大量节点时，相比于逐个插入节点，使用ocumentFragment 一次插入多个节点，性能的提升会非常明显。2此外，如果HTML 代码符合缓存条件，方法jQuery.buildFragment() 还会把转换后的DOM 元素缓存起来，下次（实际上是第三次）转换相同的HTML 代码时直接从缓存中读取，不需要重复转换。方法jQuery.buildFragment() 同时为构造jQuery 对象和DOM 操作提供底层支持，DOM操作将在第11章介绍和分析。

## 2.5 jQuery.clean( elems, context, fragment, scripts ) 

### 2.4.1 实现原理

方法jQuery.clean( elems, context, fragment, scripts ) 负责把HTML代码转换成DOM元素，并提取其中的script元素。该方法先创建一个临时的div元素，并将其插入一个安全文档片段中，然后把HTML代码赋值给div元素的innerHTML属性，浏览器会自动生成DOM元素，最后解析div元素的子元素得到转换后的DOM元素。安全文档片段指能正确渲染HTML5元素的文档片段，通过在文档片段上创建HTML5元素，可以教会浏览器正确地渲染HTML5元素，稍后的源码分析会介绍其实现过程。如果HTML代码中含有需要包裹在父标签中的子标签，例如，子标签<option>需要包裹在父标签<select>中，方法jQuery.clean()会先在HTML代码的前后加上父标签和关闭标签，在设置临时div元素的innerHTML属性生成DOM元素后，再层层剥去包裹的父元素，取出HTML代码对应的DOM元素。如果HTML代码中含有<script>标签，为了能执行<script>标签所包含的JavaScript代码或引用的JavaScript文件，在设置临时div元素的innerHTML属性生成DOM元素后，方法jQuery.clean()会提取其中的script元素放入数组scripts。注意，将含有<script>标签的HTML代码设置给某个元素的innerHTML属性后，<script>标签所包含JavaScript代码不会自动执行，所引用的JavaScript文件也不会加载和执行。在11.2.1节分析DOM操作的核心工具方法jQuery.fn.domManip()时会看到，在生成的DOM元素插入文档树后，数组scripts中的script元素会被逐个手动执行。

## 2.6 jQuery.extend()、jQuery.fn.extend()

### 2.6.1 如何使用
方法jQuery.extend() 和jQuery.fn.extend() 用于合并两个或多个对象的属性到第一个对
象，它们的语法如下：
```
jQuery.extend([deep], target, object1[, objectN])
jQuery.fn.extend([deep], target, object1[, objectN])
```

参数deep表示是一个可选的bool值，表示是否进行递归合并。合并默认是不递归的。
参数target是目标对象；参数object1和objectN是源对象包含了待合并的属性。如果只有一个对象，那么target参数被忽略，jQuery或者jQuery.fn被当做目标对象。

### 2.6.2 源码分析
